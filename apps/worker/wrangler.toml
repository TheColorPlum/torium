# Torium Worker Configuration
name = "torium-worker"
main = "src/index.ts"
compatibility_date = "2024-02-22"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "torium-db"
database_id = "a0983129-1b80-4161-9257-9dd454bfb844"

# Durable Object binding for workspace counters
[durable_objects]
bindings = [
  { name = "WORKSPACE_COUNTER", class_name = "WorkspaceCounterDO" }
]

# DO migrations - using new_sqlite_classes for free plan compatibility
[[migrations]]
tag = "v1"
new_sqlite_classes = ["WorkspaceCounterDO"]

# Queue producer binding
[[queues.producers]]
binding = "CLICKS_QUEUE"
queue = "torium-clicks"

# Queue consumer configuration
[[queues.consumers]]
queue = "torium-clicks"
max_batch_size = 100
max_batch_timeout = 30

# Environment variables (secrets - set via `wrangler secret put`)
# Required:
#   RESEND_API_KEY - API key for Resend email service
#   SESSION_SECRET - Secret for session token hashing
#   STRIPE_SECRET_KEY - Stripe API secret key (sk_live_xxx or sk_test_xxx)
#   STRIPE_WEBHOOK_SECRET - Stripe webhook signing secret (whsec_xxx)
#   STRIPE_PRO_PRICE_ID - Stripe price ID for Pro plan (price_xxx)
#
# Set using:
#   wrangler secret put RESEND_API_KEY
#   wrangler secret put SESSION_SECRET
#   wrangler secret put STRIPE_SECRET_KEY
#   wrangler secret put STRIPE_WEBHOOK_SECRET
#   wrangler secret put STRIPE_PRO_PRICE_ID

[vars]
# Non-secret configuration
APP_URL = "https://torium.app"
MAGIC_LINK_EXPIRY_MINUTES = "15"
SESSION_EXPIRY_DAYS = "30"

# Scheduled triggers (cron jobs)
[triggers]
crons = [
  "*/5 * * * *",   # Aggregation: every 5 minutes
  "0 3 * * *",     # Retention: daily at 3 AM UTC
  "0 4 * * *",     # Usage reporting (billing): daily at 4 AM UTC
  "0 5 * * *"      # Reconciliation: daily at 5 AM UTC
]

# Development overrides
[env.development]
vars = { APP_URL = "http://localhost:8787" }

# Preview environment
[env.preview]
vars = { APP_URL = "https://preview.torium.app" }
